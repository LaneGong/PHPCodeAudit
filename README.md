# PHPCodeAudit

å£°æ˜ï¼šåªæ˜¯è®°å½•å­¦ä¹ çš„è¿‡ç¨‹ï¼Œç”¨ä»¥å¤ä¹ å’Œäº’ç›¸äº¤æµå­¦ä¹ ï¼Œå…±åŒæå‡æŠ€æœ¯ï¼åˆ‡å‹¿åˆ©ç”¨æŠ€æœ¯è¿›è¡Œè¿æ³•æ´»åŠ¨ï¼Œåæœè‡ªè´Ÿï¼ï¼ç»´æŠ¤å›½å®¶ç½‘ç»œå®‰å…¨æ˜¯ä¹‰ä¸å®¹è¾çš„ä½¿å‘½ï¼Œç½‘å®‰äººå¿…å°†ç ¥ç ºèº¬è¡Œï¼âœŠğŸ»

æœ¬æ¬¡è¯•éªŒä½¿ç”¨ç¯å¢ƒï¼š[PhPstudy](https://www.xp.cn/)

æœ‰æ¡ä»¶æƒ…å†µä¸‹æ¨èä½¿ç”¨Dockeræ­å»ºï¼Œå¯ä»¥è·¨å¹³å°ã€‚åŸå…ˆæ˜¯æœ‰ä¸€ä¸ªDockerç¯å¢ƒçš„(docker-nginx-php-mysqlç¯å¢ƒ)ï¼Œå¯æƒœä»–ä¸å…¼å®¹arm64ï¼Œæ— å¥ˆæ¢ç¯å¢ƒäº†ï¼Œå½“ç„¶PhPstudyè¿˜æ˜¯å¾ˆå¥½ç”¨çš„ã€‚

> æºç æ•´ç†åœ¨ä¸Šè¿°`code`æ–‡ä»¶å¤¹ä¸­

## è¯­æ³•ç®€è¦ç»ƒä¹ GrammarExer.php

```
http://localhost/1GrammarExer.php?name=xxx&age=yy
```

## XSSæ¼æ´

### å¤ç°

å¼€å‘è€…æ²¡æœ‰å¯¹ç”¨æˆ·è¾“å…¥å’Œè¾“å‡ºåšè¿‡æ»¤

```
http://localhost/xss.php?name=<script>alert(1)</script>&age=xx
```

ç›´æ¥æ‰§è¡Œjsè„šæœ¬äº†

### é˜²å¾¡

`htmlspecialchars()` å‡½æ•°å°†é¢„å®šä¹‰çš„å­—ç¬¦è½¬æ¢ä¸º HTML å®ä½“

## ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´

ä¸Šä¼ æ–‡ä»¶æ—¶æœªè¿›è¡Œæ–‡ä»¶ç±»å‹å’Œæ ¼å¼åšåˆæ³•æ€§æ ¡éªŒï¼Œå¯¼è‡´ä»»æ„æ–‡ä»¶ä¸Šä¼ 

### å¤ç°

é¦–å…ˆåœ¨`fileupload.html`æ–‡ä»¶ä¸­å†™äº†ä¸€ä¸ªç®€æ˜“è¡¨å•é¡µé¢ï¼Œå¯ä»¥ç”¨æ¥é€‰æ‹©ä¸Šä¼ æ–‡ä»¶ï¼Œä»¥`POST`æäº¤è‡³`file.php`è¿›è¡Œå¤„ç†ï¼Œæ ¡éªŒæ–‡ä»¶å†…å®¹ç±»å‹ï¼Œå¦‚æœä¸æ˜¯`image/jpeg`å’Œ`image/png`åˆ™æŠ¥é”™`Invalid file`ï¼Œå¦‚æœæ–‡ä»¶ç±»å‹æ­£ç¡®åˆ™ä¸Šä¼ `upload`æ–‡ä»¶å¤¹ã€‚

ä¸Šä¼ jpegå’Œpngæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œæ­¤æ—¶æˆ‘ä¸Šä¼ ä¸€ä¸ªphpæ–‡ä»¶ï¼Œé€šè¿‡bsæŠ“åŒ…å‘ç°æ˜¯ä¸è¡Œçš„ã€‚

![](/images/image-20220622214944199.png)

**ç»•è¿‡**

![](/images/image-20220622215144063.png)

æˆåŠŸç»•è¿‡ã€‚

### é˜²å¾¡

æ ¸å¿ƒæ€æƒ³ï¼šéªŒè¯åç¼€

1. é‡‡å–é»‘åå•

   - å°†`.php`åˆ—ä¸ºé»‘åå•ï¼Œé—®é¢˜ï¼šé€šè¿‡å¤§å†™PHPåç¼€ç»•è¿‡ `fileblacklist1.php`
   - åœ¨ä¸Šè¿°åŸºç¡€ä¸ŠåŠ ä¸€æ­¥è½¬æ¢ä¸ºå°å†™ï¼Œä»è€Œå®ç°é˜²æŠ¤

   è¯¥æ–¹æ³•é˜²ä¸å®Œå…¨ï¼Œæˆ‘å¯ä»¥ä¸Šä¼ å…¶ä»–åç¼€æ–‡ä»¶...

2. é‡‡å–ç™½åå•ğŸŒŸ

   è¯¥æ–¹æ³•ç›¸å¯¹äºå‰ä¸€ç§ï¼Œåªå…è®¸æŸç§åç¼€é€šè¿‡ï¼Œé˜²èŒƒæ•ˆæœæ›´ä½³ï¼

## å‘½ä»¤æ³¨å…¥æ¼æ´

### å¤ç°

ä»¥è‡ªå¸¦å‘½ä»¤åšæ¼”ç¤º...

- system()
- exec()
- shell_exec()
- ......

æŸ¥çœ‹å½“å‰æ–‡ä»¶å¤¹ç›®å½•

```
http://localhost/command.php?file=.
```

æ‰§è¡Œçš„å‘½ä»¤ï¼š`ls .`

å‘½ä»¤æ³¨å…¥

```
http://localhost/command.php?file=.%20%26%26%20echo 111 %3E testcommand.txt
```

%20%26%26%20ï¼šURLç¼–ç â¡ï¸ ` && ` 

æ‰§è¡Œçš„å‘½ä»¤ï¼š`ls . && echo 111 > testcommand.txt`

### é˜²å¾¡

`escapeshellarg()`å‡½æ•°å¯¹å‚æ•°è¿›è¡Œè½¬ä¹‰

## ä»£ç æ‰§è¡Œæ¼æ´

### å¤ç°

`eval()` å‡½æ•°æŠŠå­—ç¬¦ä¸²æŒ‰ç…§ PHP ä»£ç æ¥è®¡ç®—

```
http://localhost/runcodetest.php?cmd=phpinfo();
```

`create_function()`

```
http://localhost/runcodetest.php?cmd=phpinfo();
```

## ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´

### å¤ç°

åœ¨æ–‡ä»¶ä¸‹è½½æ“ä½œä¸­ï¼Œæ–‡ä»¶ååŠè·¯å¾„ç”±å®¢æˆ·ç«¯ä¼ å…¥çš„å‚æ•°æ§åˆ¶ï¼Œå¹¶ä¸”æœªè¿›è¡Œæœ‰æ•ˆçš„è¿‡æ»¤ï¼Œå¯¼è‡´ç”¨æˆ·å¯æ¶æ„ä¸‹è½½ä»»æ„æ–‡ ä»¶ã€‚

> file_get_contents() æŠŠæ•´ä¸ªæ–‡ä»¶è¯»å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ã€‚è¯¥å‡½æ•°æ˜¯ç”¨äºæŠŠæ–‡ä»¶çš„å†…å®¹è¯»å…¥åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­çš„é¦–é€‰æ–¹æ³•ã€‚

```
http://localhost/filedownload.php?file=../../../../../../etc/passwd
```

ç”±äºæ²¡æœ‰å¯¹å‚æ•°è¿‡æ»¤ï¼Œå¯ä»¥é€šè¿‡`../`å½¢å¼è¿›è¡Œè·³è½¬ï¼Œä»è€Œè¯»åˆ°æ•æ„Ÿæ–‡ä»¶ã€‚

## ä»»æ„æ–‡ä»¶åŒ…å«æ¼æ´

### å¤ç°

```
http://localhost/fileinclude.php?file=testfileinclude.php
```

å’Œä»»æ„æ–‡ä»¶è¯»å–çš„å·®åˆ«åœ¨äºï¼š

- æ–‡ä»¶è¯»å–ï¼šä¸æ‰§è¡Œä»£ç 
- æ–‡ä»¶åŒ…å«ï¼šé€ æˆä»£ç æ‰§è¡Œï¼Œå¦‚æœä¸æ˜¯ä»£ç ï¼Œåˆ™ä¼šå¯¹æ–‡ä»¶å†…å®¹è¾“å‡ºï¼ˆâš ï¸ä¸åç¼€æ— å…³ï¼‰

## ååºåˆ—åŒ–æ¼æ´

ä½“ä¼šåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼š

```
http://localhost/serialize.php
http://localhost/unserialize.php
```

### [é­”æœ¯æ–¹æ³•](https://www.php.net/manual/zh/language.oop5.magic.php)

é­”æœ¯æ–¹æ³•æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–¹æ³•ï¼Œå½“å¯¹å¯¹è±¡æ‰§è¡ŒæŸäº›æ“ä½œæ—¶ä¼šè¦†ç›– PHP çš„é»˜è®¤æ“ä½œã€‚

|      å‡½æ•°      | è¯´æ˜                                                         |
| :------------: | :----------------------------------------------------------- |
| \__construct() | å½“å¯¹è±¡åˆ›å»º(new)æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚ä½†åœ¨unserialize()æ—¶æ˜¯ä¸ä¼šè‡ªåŠ¨è°ƒç”¨çš„ã€‚ |
| \__destruct()  | å½“å¯¹è±¡è¢«é”€æ¯æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚                                   |
|   __wakeup()   | unserialize()å‡½æ•°æ‰§è¡Œæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚                          |
|  __toString()  | å½“ååºåˆ—åŒ–åçš„å¯¹è±¡è¢«è¾“å‡ºçš„æ—¶å€™(è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„æ—¶å€™)è¢«è°ƒç”¨     |
|   __sleep()    | serialize()å‡½æ•°æ‰§è¡Œæ—¶å…ˆè¢«è°ƒç”¨                                |

`unser1.php`

> æ—¢ç„¶ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œæ˜¯å¦èƒ½åšç‚¹æœ‰æ„æ€çš„äº‹æƒ…ï¼Ÿ

### æ¼æ´åˆ©ç”¨

#### ä¼ å…¥åºåˆ—åŒ–åçš„payload

`unser2.php`é€šè¿‡ååºåˆ—åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨å‘`shell.php`å†™å…¥å†…å®¹,requireç±»ä¼¼è¿›è¡Œæ–‡ä»¶åŒ…å«æ“ä½œã€‚

```
http://localhost/unser2.php?test=O:4:%22test%22:1:{s:4:%22test%22;s:3:%22123%22;}
```

`unser3.php`ç”Ÿæˆpayloadï¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡åŒ…å«æ¶æ„ä»£ç ï¼Œè¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œè·å¾—åºåˆ—åŒ–å­—ç¬¦ä¸²å³payload

Payload:`O:4:"test":1:{s:4:"test";s:25:"<?php system('whoami') ?>";}`

è°ƒç”¨`unser2.php`ï¼Œä¼ å…¥payloadï¼Œæ‰§è¡Œååºåˆ—åŒ–æ“ä½œ

```
http://localhost/unser2.php?test=O:4:%22test%22:1:{s:4:%22test%22;s:25:%22%3C?php%20system(%27whoami%27)%20?%3E%22;}
```

#### æ²¡æ³•ä¼ å…¥payloadçš„æƒ…å†µ

`unser_phar.php`æ²¡æœ‰è°ƒç”¨`unserialize()`

[**PHarååºåˆ—åŒ–**](https://www.php.net/manual/zh/intro.phar.php)

åœ¨æ–‡ä»¶æ“ä½œå‡½æ•°ï¼ˆfile_exists()ã€is_dir()ç­‰ï¼‰å‚æ•°å¯æ§çš„æƒ…å†µä¸‹ï¼Œé…åˆphar://ä¼ªåè®®ï¼Œå¯ä»¥ä¸ä¾èµ–unserialize()ç›´æ¥è¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚

pharçš„æœ¬è´¨æ˜¯ä¸€ç§å‹ç¼©æ–‡ä»¶ï¼Œå…¶ä¸­æ¯ä¸ªè¢«å‹ç¼©æ–‡ä»¶çš„æƒé™ã€å±æ€§ç­‰ä¿¡æ¯éƒ½æ”¾åœ¨è¿™éƒ¨åˆ†ã€‚è¿™éƒ¨åˆ†è¿˜ä¼šä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„meta-dataã€‚

**æ¼æ´åˆ©ç”¨**

æœ¬è´¨ä¸Šåˆ™æ˜¯å°†payloadå†™å…¥äº†pharæ–‡ä»¶çš„meta-dataéƒ¨åˆ†ï¼Œè¯»å–æ–‡ä»¶å†…å®¹æ—¶ç›¸å½“äºä¼ å…¥äº†pharå­˜å‚¨çš„åºåˆ—åŒ–å†…å®¹ï¼Œå°†ä¼šç›´æ¥æ‰§è¡Œååºåˆ—åŒ–æ“ä½œï¼Œä»è€Œè°ƒå–__wakeup()æ–¹æ³•ï¼Œé…åˆrequireå®ç°æ–‡ä»¶åŒ…å«æ¼æ´ã€‚

1. ç”Ÿæˆpharæ–‡ä»¶ï¼Œphpæ–‡ä»¶`PharExploit.php`ï¼Œç½‘ç«™è·‘ä¸€ä¸‹å¾—åˆ°pharæ–‡ä»¶

   > âš ï¸è¦å°†php.iniä¸­çš„phar.readonlyé€‰é¡¹è®¾ç½®ä¸ºOffï¼Œé‡å¯
   
   ```ini
   [Phar]
   ; http://php.net/phar.readonly
   phar.readonly = Off
   ```

2. å°†ç”Ÿæˆçš„phar.pharæ–‡ä»¶æ”¾åˆ°ç½‘ç«™ç›®å½•ï¼Œè¿›è¡ŒEXP

   ```
   http://localhost/unser_phar.php?filename=phar://phar.phar
   ```

   

   
